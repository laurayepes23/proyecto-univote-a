// prisma/schema.prisma
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Administrador {
  id_admin         Int        @id @default(autoincrement())
  nombre_admin     String
  apellido_admin   String
  tipo_doc_admin   String
  num_doc_admin    BigInt
  correo_admin     String     @unique
  contrasena_admin String
  elections        Election[]
}

model Voter {
  id_voter         Int    @id @default(autoincrement())
  nombre_voter     String
  apellido_voter   String
  tipo_doc_voter   String
  num_doc_voter    BigInt @unique
  correo_voter     String @unique
  estado_voter     String
  contrasena_voter String

  roleId Int  @map("id_role")
  role   Role @relation(fields: [roleId], references: [id_role])

  // CAMBIO: electionId ahora es opcional
  electionId Int?      @map("id_election")
  election   Election? @relation(fields: [electionId], references: [id_election])

  careerId Int    @map("id_career")
  career   Career @relation(fields: [careerId], references: [id_career])

  vote Vote[]

  @@map("voters")
}

model Election {
  id_election     Int      @id @default(autoincrement())
  nombre_election String
  fecha_inicio    DateTime
  fecha_fin       DateTime
  estado_election String

  admin_id      Int           @map("id_admin")
  administrador Administrador @relation(fields: [admin_id], references: [id_admin])

  candidates Candidate[]
  voters     Voter[]
  result     Result?

  Vote      Vote[]
  proposals Proposal[]
}

model Candidate {
  id_candidate         Int     @id @default(autoincrement())
  nombre_candidate     String
  apellido_candidate   String
  tipo_doc_candidate   String
  num_doc_candidate    BigInt  @unique
  correo_candidate     String  @unique
  estado_candidate     String
  foto_candidate       String?
  contrasena_candidate String
  motivo_rechazo       String?

  roleId Int  @map("id_role")
  role   Role @relation(fields: [roleId], references: [id_role])

  careerId Int    @map("id_career")
  career   Career @relation(fields: [careerId], references: [id_career])

  electionId Int?      @map("id_election")
  election   Election? @relation(fields: [electionId], references: [id_election])

  proposals     Proposal[]
  result        Result?
  votes         Vote[]
  notifications Notification[]
}

model Vote {
  id_vote    Int      @id @default(autoincrement())
  fecha_vote DateTime
  hora_vote  DateTime

  // CAMBIO: Hacer voterId opcional para permitir votos sin votante espec√≠fico
  voterId Int?   @map("id_voter")
  voter   Voter? @relation(fields: [voterId], references: [id_voter])

  candidateId Int?       @map("id_candidate")
  candidate   Candidate? @relation(fields: [candidateId], references: [id_candidate])

  electionId Int?      @map("id_election")
  election   Election? @relation(fields: [electionId], references: [id_election])

  @@map("votes")
}

model Proposal {
  id_proposal          Int    @id @default(autoincrement())
  titulo_proposal      String
  descripcion_proposal String
  estado_proposal      String

  candidateId Int       @map("id_candidate")
  candidate   Candidate @relation(fields: [candidateId], references: [id_candidate])

  electionId Int?      @map("id_election")
  election   Election? @relation(fields: [electionId], references: [id_election])

  @@map("proposals")
}

model Career {
  id_career       Int    @id @default(autoincrement())
  nombre_career   String
  facultad_career String

  voters     Voter[]
  candidates Candidate[]
}

model Result {
  id_result   Int @id @default(autoincrement())
  total_votes Int

  electionId Int      @unique @map("id_election")
  election   Election @relation(fields: [electionId], references: [id_election])

  candidateId Int       @unique @map("id_candidate")
  candidate   Candidate @relation(fields: [candidateId], references: [id_candidate])
}

model Role {
  id_role     Int    @id @default(autoincrement())
  nombre_role String

  voters     Voter[]
  candidates Candidate[]
}

model Notification {
  id_notification Int      @id @default(autoincrement())
  id_candidate    Int
  titulo          String
  mensaje         String
  tipo            String // 'rechazo', 'aprobacion'
  leida           Boolean  @default(false)
  fecha_creacion  DateTime @default(now())

  candidate Candidate @relation(fields: [id_candidate], references: [id_candidate], onDelete: Cascade)

  @@map("notifications")
}
